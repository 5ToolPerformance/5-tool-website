---
// ./src/pages/services/[slug].astro
import type { SanityDocument } from "@sanity/client";
import { loadQuery } from "../../lib/load-query";
import { urlForImage } from "../../lib/urlForImage";
import Layout from "../../layouts/Layout.astro";
import type { ServicesType } from "../../lib/types";
import { Image } from "astro:assets";
import PortableTextRender from "../../components/PortableTextRender.astro";
import { getCompanyInformation } from "../../lib/companyInformation";
export const prerender = true;

// Fetch all services for static paths
export async function getStaticPaths() {
  const { data: services } = await loadQuery<SanityDocument[]>({
    query: `*[_type == "services"]`,
  });

  return services.map(({ slug }) => ({
    params: { slug: slug.current },
  }));
}

const { data: companyInfo } = await getCompanyInformation();

// Get the current service data
const { params } = Astro;
const { data: service } = await loadQuery<ServicesType>({
  query: `*[_type == "services" && slug.current == $slug][0]{
    ...
  }`,
  params,
});

// Generate image URL if available
const imageUrl = service?.image ? urlForImage(service.image).url() : "";
---

<Layout seo={companyInfo?.seo} siteUrl="https://www.5tool.com">
  <main class="min-h-screen bg-white">
    {/* Hero split: image | content */}
    <section class="w-full flex flex-col md:flex-row bg-navy text-white">
      <div class="w-full md:w-1/2">
        {
          imageUrl && (
            <Image
              src={imageUrl}
              alt={service?.image?.alt || service?.name}
              class="w-full h-full object-cover"
              loading="lazy"
              inferSize
            />
          )
        }
      </div>
      <div class="w-full md:w-1/2 p-8 md:p-16">
        <h1 class="text-4xl md:text-5xl font-bold mb-3">{service?.name}</h1>
        {
          service?.shortDescription && (
            <p class="text-lg text-white/90 max-w-2xl">
              {service.shortDescription}
            </p>
          )
        }
      </div>
    </section>

    {/* Description full-width */}
    {
      service?.description && (
        <section class="w-full bg-carolina">
          <div class="max-w-full px-4 sm:px-6 lg:px-8 py-12">
            <h2 class="text-3xl font-bold mb-6 text-navy">Service Details</h2>
            <div class="prose prose-lg max-w-none text-navy-800">
              {service.description && (
                <PortableTextRender content={service.description} />
              )}
            </div>
          </div>
        </section>
      )
    }

    {/* Pricing full-width */}
    {
      service?.pricingInfo && service.pricingInfo.length > 0 && (
        <section class="w-full bg-white text-navy">
          <div class="max-w-full px-4 sm:px-6 lg:px-8 py-12">
            <h2 class="text-3xl font-bold mb-6">Pricing Options</h2>
            <div class="flex flex-col divide-y divide-navy/20">
              {service.pricingInfo.map((item) => (
                <div class="grid grid-cols-12 items-center py-3">
                  <p class="col-span-6 font-medium text-navy">{item.title}</p>
                  <p class="col-span-3 text-center text-base font-semibold tabular-nums text-navy">
                    {item.price}
                  </p>
                  <a
                    href={item.link}
                    class="col-span-3 justify-self-end inline-flex items-center justify-center px-3 py-1.5 bg-navy text-white rounded-none hover:bg-navy/90 transition-colors duration-200 text-sm font-medium"
                  >
                    Book Now
                  </a>
                </div>
              ))}
            </div>
          </div>
        </section>
      )
    }

    {/* CTA full-width */}
    <section class="w-full py-12 bg-navy text-white text-center">
      <h2 class="text-3xl font-bold mb-4">Ready to Get Started?</h2>
      <p class="text-lg mb-8 max-w-3xl mx-auto">
        Contact us today to learn more about our {service?.name.toLowerCase()} services
        and how we can help you achieve your goals.
      </p>
      <a
        href="/contact"
        class="inline-flex items-center px-6 py-3 text-base font-medium text-navy bg-white hover:bg-white/90 transition-colors rounded-none"
      >
        Get in Touch
      </a>
    </section>
  </main>
</Layout>

<style>
  .prose {
    line-height: 1.7;
  }
  .prose p:not(:last-child) {
    margin-bottom: 1.25em;
  }
</style>
